<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flight Path Globe</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
    <style>
      :root {
        color-scheme: light dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        overflow: hidden;
        background-color: #0c0c1a;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #fff;
      }

      canvas {
        display: block;
      }

      #scene {
        position: fixed;
        inset: 0;
      }

      #info-panel {
        position: absolute;
        top: 16px;
        left: 16px;
        padding: 12px 14px;
        background: rgba(0, 0, 0, 0.65);
        border-radius: 12px;
        backdrop-filter: blur(6px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        width: min(240px, calc(100% - 32px));
        transition: opacity 160ms ease, transform 160ms ease;
      }

      h1 {
        margin: 0 0 10px 0;
        font-size: clamp(1.1rem, 3vw, 1.4rem);
      }

      p {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        line-height: 1.45;
        color: rgba(255, 255, 255, 0.78);
      }

      .inputs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.65rem;
        margin-bottom: 0.35rem;
      }

      label {
        display: block;
        margin-bottom: 0.35rem;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.88rem;
      }

      input[type="text"] {
        width: 100%;
        padding: 0.48rem 0.7rem;
        border-radius: 9px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.04);
        color: #fff;
        outline: none;
        font-size: 0.9rem;
        transition: border 120ms ease, box-shadow 120ms ease;
      }

      input[type="text"]:focus {
        border-color: #7ae1ff;
        box-shadow: 0 0 0 3px rgba(122, 225, 255, 0.2);
      }

      button {
        margin-top: 0.4rem;
        padding: 0.85rem 1.1rem;
        border: none;
        border-radius: 10px;
        background: linear-gradient(120deg, #76f7ff, #7affc7);
        color: #001c28;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(118, 247, 255, 0.25);
        transition: transform 120ms ease, box-shadow 140ms ease;
      }

      button:active {
        transform: translateY(1px);
      }

      #error {
        min-height: 1.2rem;
        color: #ffc2c2;
        margin-top: 0.35rem;
        font-size: 0.95rem;
      }

      #legend {
        display: flex;
        gap: 0.6rem;
        align-items: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-top: 0.45rem;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }

      .origin {
        background: #7ae1ff;
        box-shadow: 0 0 12px rgba(122, 225, 255, 0.9);
      }

      .destination {
        background: #ffd166;
        box-shadow: 0 0 12px rgba(255, 209, 102, 0.9);
      }

      #info-panel.collapsed {
        opacity: 0;
        transform: translateY(-8px);
        pointer-events: none;
      }

      #panel-toggle {
        position: absolute;
        top: 14px;
        left: 14px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.7);
        color: #e8f7ff;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.35);
      }

      #panel-toggle:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      @media (max-width: 640px) {
        #info-panel {
          top: 12px;
          left: 12px;
          width: calc(100% - 24px);
        }
      }
    </style>
  </head>
  <body>
    <div id="scene"></div>
    <button id="panel-toggle" hidden aria-label="Expand flight selector">Flight selector</button>
    <div id="info-panel">
      <h1>Flight Path Globe</h1>
      <p>Select two airports to draw a smooth great-circle path on the high-fidelity globe.</p>
      <div class="inputs">
        <div>
          <label for="from">Departure airport</label>
          <input id="from" list="airportOptions" type="text" placeholder="e.g. LAX, Los Angeles" />
        </div>
        <div>
          <label for="to">Arrival airport</label>
          <input id="to" list="airportOptions" type="text" placeholder="e.g. JFK, New York" />
        </div>
      </div>
      <datalist id="airportOptions"></datalist>
      <button id="plot">Plot route</button>
      <div id="error"></div>
      <div id="legend"><span class="dot origin"></span> Departure <span class="dot destination"></span> Arrival</div>
    </div>

    <script type="module">
      import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
      import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';

      const airports = [
        { city: 'Abu Dhabi', name: 'Abu Dhabi', code: 'AUH', lat: 24.4539, lon: 54.3773 },
        { city: 'Addis Ababa', name: 'Bole', code: 'ADD', lat: 8.9779, lon: 38.7993 },
        { city: 'Amsterdam', name: 'Schiphol', code: 'AMS', lat: 52.3105, lon: 4.7683 },
        { city: 'Anchorage', name: 'Ted Stevens', code: 'ANC', lat: 61.1743, lon: -149.9985 },
        { city: 'Athens', name: 'Eleftherios Venizelos', code: 'ATH', lat: 37.9364, lon: 23.9475 },
        { city: 'Atlanta', name: 'Hartsfield-Jackson', code: 'ATL', lat: 33.6407, lon: -84.4277 },
        { city: 'Auckland', name: 'Auckland', code: 'AKL', lat: -37.0082, lon: 174.785 },
        { city: 'Austin', name: 'Austin-Bergstrom', code: 'AUS', lat: 30.1975, lon: -97.6664 },
        { city: 'Barcelona', name: 'El Prat', code: 'BCN', lat: 41.2974, lon: 2.0833 },
        { city: 'Baltimore', name: 'Baltimore/Washington', code: 'BWI', lat: 39.1754, lon: -76.6684 },
        { city: 'Bangkok', name: 'Suvarnabhumi', code: 'BKK', lat: 13.690, lon: 100.7501 },
        { city: 'Beijing', name: 'Capital', code: 'PEK', lat: 40.0799, lon: 116.6031 },
        { city: 'Bengaluru', name: 'Kempegowda', code: 'BLR', lat: 13.1986, lon: 77.7066 },
        { city: 'Bogotá', name: 'El Dorado', code: 'BOG', lat: 4.7016, lon: -74.1469 },
        { city: 'Boston', name: 'Logan', code: 'BOS', lat: 42.3656, lon: -71.0096 },
        { city: 'Brussels', name: 'Brussels', code: 'BRU', lat: 50.901, lon: 4.4844 },
        { city: 'Buenos Aires', name: 'Ezeiza', code: 'EZE', lat: -34.8222, lon: -58.5358 },
        { city: 'Cairo', name: 'Cairo Intl', code: 'CAI', lat: 30.1219, lon: 31.4056 },
        { city: 'Calgary', name: 'Calgary', code: 'YYC', lat: 51.1139, lon: -114.0201 },
        { city: 'Cape Town', name: 'Cape Town Intl', code: 'CPT', lat: -33.9696, lon: 18.5972 },
        { city: 'Casablanca', name: 'Mohammed V', code: 'CMN', lat: 33.3675, lon: -7.58997 },
        { city: 'Charlotte', name: 'Douglas', code: 'CLT', lat: 35.214, lon: -80.9431 },
        { city: 'Chengdu', name: 'Shuangliu', code: 'CTU', lat: 30.5785, lon: 103.9471 },
        { city: 'Chicago', name: "O'Hare", code: 'ORD', lat: 41.9742, lon: -87.9073 },
        { city: 'Copenhagen', name: 'Kastrup', code: 'CPH', lat: 55.6181, lon: 12.6561 },
        { city: 'Dallas/Fort Worth', name: 'Dallas/Fort Worth', code: 'DFW', lat: 32.8998, lon: -97.0403 },
        { city: 'Delhi', name: 'Indira Gandhi', code: 'DEL', lat: 28.5562, lon: 77.1 },
        { city: 'Denver', name: 'Denver Intl', code: 'DEN', lat: 39.8561, lon: -104.6737 },
        { city: 'Detroit', name: 'Detroit Metro', code: 'DTW', lat: 42.2124, lon: -83.3534 },
        { city: 'Doha', name: 'Hamad Intl', code: 'DOH', lat: 25.2731, lon: 51.6081 },
        { city: 'Dubai', name: 'Dubai International', code: 'DXB', lat: 25.2532, lon: 55.3657 },
        { city: 'Dublin', name: 'Dublin', code: 'DUB', lat: 53.4213, lon: -6.2701 },
        { city: 'Düsseldorf', name: 'Düsseldorf', code: 'DUS', lat: 51.2895, lon: 6.7668 },
        { city: 'Edinburgh', name: 'Edinburgh', code: 'EDI', lat: 55.95, lon: -3.3725 },
        { city: 'Frankfurt', name: 'Frankfurt', code: 'FRA', lat: 50.0379, lon: 8.5622 },
        { city: 'Guangzhou', name: 'Baiyun', code: 'CAN', lat: 23.3924, lon: 113.2988 },
        { city: 'Guarulhos', name: 'São Paulo/Guarulhos', code: 'GRU', lat: -23.4356, lon: -46.4731 },
        { city: 'Hamburg', name: 'Hamburg', code: 'HAM', lat: 53.6304, lon: 9.9882 },
        { city: 'Haneda (Tokyo)', name: 'Haneda', code: 'HND', lat: 35.5494, lon: 139.7798 },
        { city: 'Hanoi', name: 'Noi Bai', code: 'HAN', lat: 21.2212, lon: 105.8072 },
        { city: 'Helsinki', name: 'Vantaa', code: 'HEL', lat: 60.3172, lon: 24.9633 },
        { city: 'Ho Chi Minh City', name: 'Tan Son Nhat', code: 'SGN', lat: 10.8188, lon: 106.6518 },
        { city: 'Hoedspruit', name: 'Eastgate', code: 'HDS', lat: -24.3686, lon: 31.0487 },
        { city: 'Hong Kong', name: 'Hong Kong Intl', code: 'HKG', lat: 22.308, lon: 113.9185 },
        { city: 'Honolulu', name: 'Daniel K. Inouye', code: 'HNL', lat: 21.3245, lon: -157.9251 },
        { city: 'Houston', name: 'George Bush', code: 'IAH', lat: 29.9902, lon: -95.3368 },
        { city: 'Istanbul', name: 'Istanbul Airport', code: 'IST', lat: 41.2753, lon: 28.7519 },
        { city: 'Jakarta', name: 'Soekarno–Hatta', code: 'CGK', lat: -6.1256, lon: 106.6559 },
        { city: 'Jeddah', name: 'King Abdulaziz', code: 'JED', lat: 21.6702, lon: 39.1528 },
        { city: 'Johannesburg', name: 'OR Tambo', code: 'JNB', lat: -26.1337, lon: 28.242 },
        { city: 'Kansai (Osaka)', name: 'Kansai', code: 'KIX', lat: 34.4273, lon: 135.244 },
        { city: 'Kuala Lumpur', name: 'Kuala Lumpur Intl', code: 'KUL', lat: 2.7456, lon: 101.7072 },
        { city: 'Las Vegas', name: 'Harry Reid', code: 'LAS', lat: 36.084, lon: -115.1537 },
        { city: 'Lima', name: 'Jorge Chávez', code: 'LIM', lat: -12.0219, lon: -77.1143 },
        { city: 'Lisbon', name: 'Humberto Delgado', code: 'LIS', lat: 38.7742, lon: -9.1342 },
        { city: 'London', name: 'Gatwick', code: 'LGW', lat: 51.1537, lon: -0.1821 },
        { city: 'London', name: 'Heathrow', code: 'LHR', lat: 51.47, lon: -0.4543 },
        { city: 'Los Angeles', name: 'Los Angeles Intl', code: 'LAX', lat: 33.9416, lon: -118.4085 },
        { city: 'Madrid', name: 'Barajas', code: 'MAD', lat: 40.4983, lon: -3.5676 },
        { city: 'Manila', name: 'Ninoy Aquino', code: 'MNL', lat: 14.5086, lon: 121.0198 },
        { city: 'Manchester', name: 'Manchester', code: 'MAN', lat: 53.3537, lon: -2.27495 },
        { city: 'Melbourne', name: 'Tullamarine', code: 'MEL', lat: -37.6733, lon: 144.843 },
        { city: 'Orlando', name: 'Orlando Intl', code: 'MCO', lat: 28.4312, lon: -81.3081 },
        { city: 'Mexico City', name: 'Benito Juárez', code: 'MEX', lat: 19.4361, lon: -99.0719 },
        { city: 'Miami', name: 'Miami Intl', code: 'MIA', lat: 25.7959, lon: -80.287 },
        { city: 'Minneapolis', name: 'Saint Paul', code: 'MSP', lat: 44.883, lon: -93.2223 },
        { city: 'Montréal', name: 'Trudeau', code: 'YUL', lat: 45.4706, lon: -73.7408 },
        { city: 'Moscow', name: 'Sheremetyevo', code: 'SVO', lat: 55.9728, lon: 37.4146 },
        { city: 'Mumbai', name: 'Chhatrapati Shivaji', code: 'BOM', lat: 19.0896, lon: 72.8656 },
        { city: 'Munich', name: 'Munich', code: 'MUC', lat: 48.3538, lon: 11.7861 },
        { city: 'Nagoya', name: 'Chubu Centrair', code: 'NGO', lat: 34.8584, lon: 136.8044 },
        { city: 'New York', name: 'John F. Kennedy', code: 'JFK', lat: 40.6413, lon: -73.7781 },
        { city: 'New York', name: 'LaGuardia', code: 'LGA', lat: 40.7769, lon: -73.874 },
        { city: 'Newark', name: 'Newark Liberty', code: 'EWR', lat: 40.6895, lon: -74.1745 },
        { city: 'Oslo', name: 'Gardermoen', code: 'OSL', lat: 60.1939, lon: 11.1004 },
        { city: 'Paris', name: 'Charles de Gaulle', code: 'CDG', lat: 49.0097, lon: 2.5479 },
        { city: 'Paris', name: 'Orly', code: 'ORY', lat: 48.7262, lon: 2.3652 },
        { city: 'Perth', name: 'Perth', code: 'PER', lat: -31.9403, lon: 115.967 },
        { city: 'Philadelphia', name: 'Philadelphia', code: 'PHL', lat: 39.8744, lon: -75.2424 },
        { city: 'Phoenix', name: 'Sky Harbor', code: 'PHX', lat: 33.4352, lon: -112.009 },
        { city: 'Prague', name: 'Václav Havel', code: 'PRG', lat: 50.1008, lon: 14.26 },
        { city: 'Rio de Janeiro', name: 'Galeão', code: 'GIG', lat: -22.8099, lon: -43.2506 },
        { city: 'Riyadh', name: 'King Khalid', code: 'RUH', lat: 24.9596, lon: 46.7029 },
        { city: 'Rome', name: 'Fiumicino', code: 'FCO', lat: 41.8003, lon: 12.2389 },
        { city: 'Salt Lake City', name: 'Salt Lake City', code: 'SLC', lat: 40.7899, lon: -111.9791 },
        { city: 'San Diego', name: 'San Diego Intl', code: 'SAN', lat: 32.7338, lon: -117.1933 },
        { city: 'San Francisco', name: 'San Francisco Intl', code: 'SFO', lat: 37.6213, lon: -122.379 },
        { city: 'San Jose', name: 'Mineta San Jose', code: 'SJC', lat: 37.3639, lon: -121.9289 },
        { city: 'Santiago', name: 'Arturo Merino Benítez', code: 'SCL', lat: -33.3928, lon: -70.7856 },
        { city: 'São Paulo', name: 'Congonhas', code: 'CGH', lat: -23.6261, lon: -46.6566 },
        { city: 'Seattle', name: 'Seattle-Tacoma', code: 'SEA', lat: 47.4502, lon: -122.3088 },
        { city: 'Seoul', name: 'Incheon', code: 'ICN', lat: 37.4602, lon: 126.4407 },
        { city: 'Shenzhen', name: 'Bao’an', code: 'SZX', lat: 22.6393, lon: 113.8108 },
        { city: 'Shanghai', name: 'Pudong', code: 'PVG', lat: 31.1443, lon: 121.8083 },
        { city: 'Singapore', name: 'Changi', code: 'SIN', lat: 1.3644, lon: 103.9915 },
        { city: 'St. Petersburg', name: 'Pulkovo', code: 'LED', lat: 59.8003, lon: 30.2625 },
        { city: 'Stockholm', name: 'Arlanda', code: 'ARN', lat: 59.6519, lon: 17.9186 },
        { city: 'Sydney', name: 'Kingsford Smith', code: 'SYD', lat: -33.9399, lon: 151.1753 },
        { city: 'Taipei', name: 'Taoyuan', code: 'TPE', lat: 25.0797, lon: 121.2328 },
        { city: 'Tel Aviv', name: 'Ben Gurion', code: 'TLV', lat: 32.0005, lon: 34.8708 },
        { city: 'Tokyo', name: 'Narita', code: 'NRT', lat: 35.7719, lon: 140.3929 },
        { city: 'Toronto', name: 'Pearson', code: 'YYZ', lat: 43.6777, lon: -79.6248 },
        { city: 'Vancouver', name: 'Vancouver', code: 'YVR', lat: 49.1951, lon: -123.1779 },
        { city: 'Vienna', name: 'Vienna', code: 'VIE', lat: 48.1103, lon: 16.5697 },
        { city: 'Warsaw', name: 'Chopin', code: 'WAW', lat: 52.1657, lon: 20.9671 },
        { city: 'Washington D.C.', name: 'Dulles', code: 'IAD', lat: 38.9531, lon: -77.4565 },
        { city: 'Washington D.C.', name: 'Reagan', code: 'DCA', lat: 38.8512, lon: -77.0402 },
        { city: 'Zurich', name: 'Zurich', code: 'ZRH', lat: 47.4581, lon: 8.5555 }
      ];

      const sceneEl = document.getElementById('scene');
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      sceneEl.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 3;

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 1.5;
      controls.maxDistance = 10;
      controls.enablePan = false;

      const earthRadius = 1;
      const earthGeometry = new THREE.SphereGeometry(earthRadius, 64, 64);
      const textureLoader = new THREE.TextureLoader();
      const earthTexture = textureLoader.load(
        'https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg',
        () => {
          startAnimation();
        },
        undefined,
        (error) => {
          console.error('An error occurred while loading the texture:', error);
          const fallbackMaterial = new THREE.MeshStandardMaterial({ color: 0x0077ff, roughness: 0.8 });
          earth.material = fallbackMaterial;
          startAnimation();
        }
      );
      const earthMaterial = new THREE.MeshStandardMaterial({ map: earthTexture, roughness: 0.85, metalness: 0.1 });
      const earth = new THREE.Mesh(earthGeometry, earthMaterial);
      scene.add(earth);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.15);
      scene.add(ambientLight);
      const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
      scene.add(sunLight);

      const starVertices = [];
      for (let i = 0; i < 10000; i++) {
        const x = (Math.random() - 0.5) * 2000;
        const y = (Math.random() - 0.5) * 2000;
        const z = (Math.random() - 0.5) * 2000;
        const dist = x * x + y * y + z * z;
        if (dist > 10000 && dist < 800000) {
          starVertices.push(x, y, z);
        }
      }
      const starGeometry = new THREE.BufferGeometry();
      starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
      const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.3, transparent: true, opacity: 0.8 });
      const stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);

      const markers = new THREE.Group();
      const routes = new THREE.Group();
      scene.add(markers, routes);

      const toRadians = THREE.MathUtils.degToRad;
      const latLonToVector3 = (lat, lon, radius = earthRadius) => {
        const phi = toRadians(lat);
        const theta = toRadians(lon - 180);
        const x = -(radius * Math.cos(phi) * Math.cos(theta));
        const y = radius * Math.sin(phi);
        const z = radius * Math.cos(phi) * Math.sin(theta);
        return new THREE.Vector3(x, y, z);
      };

      const addGlowMarker = (position, color) => {
        const marker = new THREE.Mesh(
          new THREE.SphereGeometry(0.014, 20, 20),
          new THREE.MeshBasicMaterial({ color })
        );
        marker.position.copy(position.clone().setLength(earthRadius + 0.003));
        markers.add(marker);
      };

      const airportOptions = document.getElementById('airportOptions');
      airports.forEach((airport) => {
        const option = document.createElement('option');
        option.value = `${airport.code} — ${airport.city}`;
        airportOptions.appendChild(option);
      });

      const errorEl = document.getElementById('error');
      const fromInput = document.getElementById('from');
      const toInput = document.getElementById('to');
      const plotBtn = document.getElementById('plot');
      const infoPanel = document.getElementById('info-panel');
      const panelToggle = document.getElementById('panel-toggle');

      const expandPanel = () => {
        infoPanel.classList.remove('collapsed');
        panelToggle.hidden = true;
        fromInput.focus();
      };

      const collapsePanel = (label) => {
        infoPanel.classList.add('collapsed');
        panelToggle.hidden = false;
        panelToggle.textContent = label || 'Flight selector';
      };

      panelToggle.addEventListener('click', expandPanel);

      const normalizeInput = (value) => value.trim().toLowerCase();
      const findAirport = (value) => {
        const normalizedValue = normalizeInput(value);
        const tokens = normalizedValue
          .split(/[—-]/)
          .map((part) => part.trim())
          .filter(Boolean);
        const candidates = [normalizedValue, ...tokens].filter(Boolean);

        return airports.find((airport) => {
          const code = normalizeInput(airport.code);
          const city = normalizeInput(airport.city);
          const name = normalizeInput(airport.name);
          return candidates.some((candidate) => candidate === code || candidate === city || candidate === name);
        });
      };

      const clearRoute = () => {
        while (routes.children.length) routes.remove(routes.children[0]);
        while (markers.children.length) markers.remove(markers.children[0]);
      };

      const buildCurve = (start, end) => {
        const startVec = latLonToVector3(start.lat, start.lon).normalize();
        const endVec = latLonToVector3(end.lat, end.lon).normalize();

        let axis = new THREE.Vector3().crossVectors(startVec, endVec);
        if (axis.lengthSq() === 0) {
          axis = new THREE.Vector3(0, 1, 0).cross(startVec);
        }
        if (axis.lengthSq() === 0) {
          axis = new THREE.Vector3(1, 0, 0);
        }
        axis.normalize();

        const angle = startVec.angleTo(endVec);
        const segments = 256;
        const points = [];
        for (let i = 0; i <= segments; i++) {
          const t = i / segments;
          const point = startVec
            .clone()
            .applyAxisAngle(axis, angle * t)
            .setLength(earthRadius + 0.003);
          points.push(point);
        }

        const curve = new THREE.CatmullRomCurve3(points);
        const tube = new THREE.TubeGeometry(curve, 256, 0.0075, 10, false);
        const gradient = new THREE.MeshBasicMaterial({ color: 0x7ae1ff, transparent: true, opacity: 0.92 });
        const mesh = new THREE.Mesh(tube, gradient);
        return { mesh, startVec: startVec.clone().setLength(earthRadius), endVec: endVec.clone().setLength(earthRadius) };
      };

      const plotRoute = () => {
        const fromAirport = findAirport(fromInput.value);
        const toAirport = findAirport(toInput.value);
        clearRoute();

        if (!fromAirport || !toAirport) {
          errorEl.textContent = 'Please pick two airports from the list.';
          return;
        }
        if (fromAirport.code === toAirport.code) {
          errorEl.textContent = 'Choose two different airports to draw a path.';
          return;
        }

        const { mesh, startVec, endVec } = buildCurve(fromAirport, toAirport);
        routes.add(mesh);
        addGlowMarker(startVec, 0x7ae1ff);
        addGlowMarker(endVec, 0xffd166);
        errorEl.textContent = `${fromAirport.code} ➜ ${toAirport.code}`;
        collapsePanel(`${fromAirport.code} ➜ ${toAirport.code}`);
      };

      plotBtn.addEventListener('click', plotRoute);
      [fromInput, toInput].forEach((input) => {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') plotRoute();
        });
      });

      const onResize = () => {
        const { innerWidth, innerHeight } = window;
        renderer.setSize(innerWidth, innerHeight);
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
      };
      window.addEventListener('resize', onResize);

      function updateSunPosition() {
        const now = new Date();
        const timeFraction = (now.getUTCHours() * 3600 + now.getUTCMinutes() * 60 + now.getUTCSeconds()) / 86400;
        const start = new Date(now.getUTCFullYear(), 0, 0);
        const diff = now - start;
        const oneDay = 1000 * 60 * 60 * 24;
        const dayOfYear = Math.floor(diff / oneDay);
        const declination = -23.45 * Math.cos((2 * Math.PI) / 365 * (dayOfYear + 10)) * (Math.PI / 180);
        const noonLongitude = (0.5 - timeFraction) * 2 * Math.PI;
        const sunX = Math.cos(noonLongitude) * Math.cos(declination);
        const sunY = Math.sin(declination);
        const sunZ = Math.sin(noonLongitude) * Math.cos(declination);
        sunLight.position.set(sunX, sunY, sunZ).normalize();
      }

      let animationStarted = false;
      function startAnimation() {
        if (animationStarted) return;
        animationStarted = true;
        animate();
      }

      function animate() {
        requestAnimationFrame(animate);
        updateSunPosition();
        stars.rotation.y += 0.00005;
        controls.update();
        renderer.render(scene, camera);
      }

      updateSunPosition();
      startAnimation();
    </script>
  </body>
</html>
