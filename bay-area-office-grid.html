<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bay Area Office Space Grid</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #0b1320;
        --panel: rgba(12, 22, 38, 0.9);
        --panel-border: rgba(255, 255, 255, 0.08);
        --text: #e8f0ff;
        --muted: #9fb0d9;
        --accent: #7dd3fc;
        --grid-stroke: rgba(170, 210, 255, 0.24);
        --pillar-shadow: rgba(10, 15, 25, 0.35);
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      body {
        display: grid;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      header {
        padding: 16px 20px 10px;
        border-bottom: 1px solid var(--panel-border);
        background: linear-gradient(180deg, rgba(18, 34, 58, 0.95), rgba(11, 19, 32, 0.95));
        backdrop-filter: blur(6px);
        position: relative;
        z-index: 1000;
      }

      header h1 {
        margin: 0 0 4px;
        font-size: clamp(18px, 2.4vw, 26px);
        letter-spacing: 0.2px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
        max-width: 1100px;
        line-height: 1.4;
      }

      #app {
        position: relative;
        min-height: 0;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .panel {
        position: absolute;
        z-index: 900;
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.02);
        color: var(--text);
        padding: 12px 14px;
        backdrop-filter: blur(8px);
      }

      #controls {
        top: 16px;
        left: 16px;
        width: min(320px, calc(100% - 32px));
        display: grid;
        gap: 10px;
      }

      #controls h2 {
        margin: 0;
        font-size: 15px;
        letter-spacing: 0.3px;
        color: var(--accent);
      }

      .control-group {
        display: grid;
        gap: 6px;
      }

      .control-group label {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: baseline;
      }

      .control-group input[type="range"] {
        width: 100%;
        accent-color: var(--accent);
      }

      .control-note {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.4;
      }

      #stats {
        right: 16px;
        bottom: 16px;
        width: min(360px, calc(100% - 32px));
        display: grid;
        gap: 8px;
      }

      #stats h2 {
        margin: 0;
        font-size: 15px;
        color: var(--accent);
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 13px;
      }

      .stat-row strong {
        font-size: 16px;
        color: #ffffff;
      }

      .legend-scale {
        margin-top: 4px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(
          90deg,
          #ff3b30,
          #ff9500,
          #ffcc00,
          #34c759,
          #007aff,
          #5856d6,
          #af52de
        );
      }

      .legend-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
      }

      .source-list {
        margin: 6px 0 0;
        padding-left: 16px;
        display: grid;
        gap: 4px;
        font-size: 11px;
        color: var(--muted);
      }

      .source-list a {
        color: #c7e2ff;
      }

      .leaflet-container {
        background: #0a1220;
      }

      .leaflet-tooltip.office-tooltip {
        background: rgba(12, 22, 38, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: var(--text);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
        padding: 8px 10px;
      }

      .leaflet-tooltip.office-tooltip .tooltip-title {
        font-size: 12px;
        color: var(--accent);
        margin-bottom: 2px;
        letter-spacing: 0.2px;
      }

      .leaflet-tooltip.office-tooltip .tooltip-value {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
      }

      .pillar-icon {
        border-radius: 4px;
        transform-origin: bottom center;
        pointer-events: none;
      }

      .pillar {
        position: relative;
        width: var(--pillar-size);
        height: calc(var(--pillar-size) + var(--pillar-height));
        transform: translateY(calc(-1 * var(--pillar-height)));
      }

      .pillar .pillar-top {
        position: absolute;
        bottom: var(--pillar-height);
        left: 0;
        width: var(--pillar-size);
        height: var(--pillar-size);
        background: var(--pillar-color);
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 6px 16px var(--pillar-shadow);
        transform: perspective(220px) rotateX(55deg);
        transform-origin: center bottom;
      }

      .pillar .pillar-body {
        position: absolute;
        bottom: 0;
        left: 0;
        width: var(--pillar-size);
        height: var(--pillar-height);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.35));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
        background-color: color-mix(in srgb, var(--pillar-color) 75%, #000);
      }

      @media (max-width: 860px) {
        #controls {
          position: static;
          margin: 12px;
          width: auto;
        }

        #stats {
          position: static;
          margin: 0 12px 12px;
          width: auto;
        }

        #app {
          display: grid;
          grid-template-rows: auto 1fr auto;
        }

        #map {
          min-height: min(68vh, 700px);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>San Francisco Bay Area Office Space Grid</h1>
      <p>
        A gridded cartogram overlay that approximates office square footage across the Bay Area. The map uses a
        1&nbsp;km base grid and distributes metro-level inventory estimates into grid cells using proximity to known
        employment centers.
      </p>
    </header>

    <div id="app">
      <div id="controls" class="panel">
        <h2>Grid configuration</h2>
        <div class="control-group">
          <label>
            Cell size
            <span id="cellSizeValue">1.0 km</span>
          </label>
          <div class="control-note">Grid cells are fixed at 1&nbsp;km squares for consistent comparisons.</div>
        </div>
        <div class="control-group">
          <label for="intensity">
            Intensity scaling
            <span id="intensityValue">1.0×</span>
          </label>
          <input id="intensity" type="range" min="0.6" max="1.8" step="0.1" value="1" />
          <div class="control-note">Boost or soften the color ramp without changing totals.</div>
        </div>
        <div class="control-note">
          Hover any grid cell to see the estimated office inventory. Click to lock the tooltip while exploring.
        </div>
      </div>

      <div id="map" role="img" aria-label="Grid map of office space in the San Francisco Bay Area"></div>

      <div id="stats" class="panel" aria-live="polite">
        <h2>Regional summary</h2>
        <div class="stat-row"><span>Total office inventory</span><strong id="totalOffice">–</strong></div>
        <div class="stat-row"><span>Grid cells</span><strong id="cellCount">–</strong></div>
        <div class="stat-row"><span>Peak cell</span><strong id="peakCell">–</strong></div>
        <div class="legend-scale" aria-hidden="true"></div>
        <div class="legend-labels">
          <span id="legendMin">Low</span>
          <span id="legendMid">Median</span>
          <span id="legendMax">High</span>
        </div>
        <div class="control-note" style="margin-top: 6px">
          Candidate public data sources you can connect to replace the seed estimates:
        </div>
        <ul class="source-list">
          <li>
            <a href="https://learn.microsoft.com/en-us/azure/azure-maps/map-data" target="_blank" rel="noreferrer"
              >Microsoft US Building Footprints</a
            >
          </li>
          <li>
            <a href="https://overpass-turbo.eu/" target="_blank" rel="noreferrer">OpenStreetMap (office tags)</a>
          </li>
          <li>
            <a href="https://mtc.ca.gov/data-tools" target="_blank" rel="noreferrer"
              >Metropolitan Transportation Commission data portal</a
            >
          </li>
          <li>
            <a href="https://data.sfgov.org/" target="_blank" rel="noreferrer">SF Open Data (assessor + land use)</a>
          </li>
        </ul>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      // Approximate metro-level inventory estimates (square feet) seeded from public market summaries.
      const metroInventory = [
        { name: "San Francisco", lat: 37.789, lng: -122.401, sqft: 92_000_000 },
        { name: "Oakland / East Bay Core", lat: 37.804, lng: -122.271, sqft: 34_000_000 },
        { name: "San Jose / Silicon Valley", lat: 37.336, lng: -121.89, sqft: 118_000_000 },
        { name: "Peninsula (Redwood City / Palo Alto)", lat: 37.486, lng: -122.23, sqft: 61_000_000 },
        { name: "Walnut Creek / I-680", lat: 37.91, lng: -122.065, sqft: 18_000_000 },
        { name: "North Bay (San Rafael)", lat: 37.973, lng: -122.531, sqft: 11_500_000 },
        { name: "Tri-Valley (Pleasanton)", lat: 37.662, lng: -121.875, sqft: 24_000_000 }
      ];

      const bayBounds = {
        west: -123.2,
        south: 36.8,
        east: -121.3,
        north: 38.55
      };

      const map = L.map("map", {
        zoomControl: true,
        minZoom: 7,
        maxZoom: 12,
        preferCanvas: true
      }).setView([37.72, -122.18], 9);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 12,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const gridLayer = L.layerGroup().addTo(map);
      const focusLayer = L.layerGroup().addTo(map);

      const intensityInput = document.getElementById("intensity");
      const intensityValue = document.getElementById("intensityValue");
      const totalOfficeEl = document.getElementById("totalOffice");
      const cellCountEl = document.getElementById("cellCount");
      const peakCellEl = document.getElementById("peakCell");
      const legendMinEl = document.getElementById("legendMin");
      const legendMidEl = document.getElementById("legendMid");
      const legendMaxEl = document.getElementById("legendMax");

      let lockedTooltip = null;

      const formatSqft = (value) =>
        new Intl.NumberFormat("en-US", {
          notation: value >= 10_000_000 ? "compact" : "standard",
          maximumFractionDigits: value >= 10_000_000 ? 1 : 0
        }).format(value) + " sq ft";

      const kmPerDegreeLat = 111.32;
      const kmPerDegreeLng = (lat) => 111.32 * Math.cos((lat * Math.PI) / 180);

      const distanceKm = (a, b) => {
        const dLat = (a.lat - b.lat) * kmPerDegreeLat;
        const meanLat = (a.lat + b.lat) / 2;
        const dLng = (a.lng - b.lng) * kmPerDegreeLng(meanLat);
        return Math.sqrt(dLat * dLat + dLng * dLng);
      };

      const colorForValue = (value, domainMax, intensity) => {
        if (!domainMax || value <= 0) {
          return "rgba(255, 59, 48, 0.12)";
        }
        const normalized = Math.min(1, Math.pow(value / domainMax, 0.75) * intensity);
        const hue = normalized * 275;
        const sat = 85;
        const light = 52 - normalized * 6;
        const alpha = 0.32 + normalized * 0.6;
        return `hsla(${hue}, ${sat}%, ${light}%, ${alpha})`;
      };

      const buildGrid = (cellSizeKm) => {
        const midLat = (bayBounds.north + bayBounds.south) / 2;
        const latStep = cellSizeKm / kmPerDegreeLat;
        const lngStep = cellSizeKm / kmPerDegreeLng(midLat);
        const cells = [];

        for (let lat = bayBounds.south; lat < bayBounds.north; lat += latStep) {
          const latTop = Math.min(lat + latStep, bayBounds.north);
          for (let lng = bayBounds.west; lng < bayBounds.east; lng += lngStep) {
            const lngRight = Math.min(lng + lngStep, bayBounds.east);
            const center = {
              lat: (lat + latTop) / 2,
              lng: (lng + lngRight) / 2
            };

            cells.push({
              bounds: [
                [lat, lng],
                [latTop, lngRight]
              ],
              center,
              sqft: 0
            });
          }
        }

        return cells;
      };

      const distributeInventory = (cells) => {
        for (const metro of metroInventory) {
          let weightTotal = 0;
          const weights = cells.map((cell) => {
            const d = distanceKm(cell.center, metro);
            const weight = 1 / Math.pow(Math.max(d, 5), 1.35);
            weightTotal += weight;
            return weight;
          });

          cells.forEach((cell, index) => {
            cell.sqft += (weights[index] / weightTotal) * metro.sqft;
          });
        }
      };

      const addMetroMarkers = () => {
        focusLayer.clearLayers();
        metroInventory.forEach((metro) => {
          const marker = L.circleMarker([metro.lat, metro.lng], {
            radius: 6,
            weight: 1.2,
            color: "#c7e2ff",
            fillColor: "#7dd3fc",
            fillOpacity: 0.8
          }).addTo(focusLayer);

          marker.bindTooltip(
            `<div class="tooltip-title">${metro.name}</div><div class="tooltip-value">${formatSqft(
              metro.sqft
            )}</div>`,
            {
              direction: "top",
              offset: [0, -6],
              opacity: 0.95,
              className: "office-tooltip"
            }
          );
        });
      };

      const updateStats = (cells) => {
        const totals = cells.map((c) => c.sqft);
        const total = totals.reduce((sum, value) => sum + value, 0);
        const peak = Math.max(...totals);
        const sorted = [...totals].sort((a, b) => a - b);
        const median = sorted[Math.floor(sorted.length / 2)];

        totalOfficeEl.textContent = formatSqft(total);
        cellCountEl.textContent = new Intl.NumberFormat("en-US").format(cells.length);
        peakCellEl.textContent = formatSqft(peak);

        legendMinEl.textContent = formatSqft(sorted[0]);
        legendMidEl.textContent = formatSqft(median);
        legendMaxEl.textContent = formatSqft(peak);
      };

      const renderGrid = () => {
        const cellSizeKm = 1;
        const intensity = Number(intensityInput.value);

        intensityValue.textContent = `${intensity.toFixed(1)}×`;

        const cells = buildGrid(cellSizeKm);
        distributeInventory(cells);

        const maxSqft = Math.max(...cells.map((c) => c.sqft));

        gridLayer.clearLayers();
        if (lockedTooltip) {
          map.closeTooltip(lockedTooltip);
          lockedTooltip = null;
        }

        cells.forEach((cell) => {
          const color = colorForValue(cell.sqft, maxSqft, intensity);
          const southWestPoint = map.latLngToLayerPoint(cell.bounds[0]);
          const northEastPoint = map.latLngToLayerPoint(cell.bounds[1]);
          const baseSize = Math.max(10, Math.abs(northEastPoint.x - southWestPoint.x));
          const heightPx = Math.max(6, Math.round((cell.sqft / maxSqft) * 80));

          const icon = L.divIcon({
            className: "pillar-icon",
            html: `
              <div class="pillar" style="--pillar-color:${color};--pillar-size:${baseSize}px;--pillar-height:${heightPx}px;">
                <div class="pillar-top"></div>
                <div class="pillar-body"></div>
              </div>
            `,
            iconSize: [baseSize, baseSize + heightPx],
            iconAnchor: [baseSize / 2, baseSize + heightPx]
          });

          const marker = L.marker(cell.center, { icon }).addTo(gridLayer);

          const tooltipHtml = `
            <div class="tooltip-title">Estimated office inventory</div>
            <div class="tooltip-value">${formatSqft(cell.sqft)}</div>
            <div style="margin-top:4px;font-size:11px;color:#9fb0d9">Cell center: ${cell.center.lat.toFixed(
              3
            )}, ${cell.center.lng.toFixed(3)}</div>
          `;

          marker.bindTooltip(tooltipHtml, {
            sticky: true,
            opacity: 0.96,
            className: "office-tooltip"
          });

          marker.on("click", (event) => {
            if (lockedTooltip) {
              map.closeTooltip(lockedTooltip);
              lockedTooltip = null;
            }
            const tooltip = marker.getTooltip();
            marker.openTooltip(event.latlng);
            lockedTooltip = tooltip;
          });
        });

        updateStats(cells);
      };

      intensityInput.addEventListener("input", renderGrid);
      map.on("zoomend moveend", renderGrid);

      addMetroMarkers();
      renderGrid();

      // Candidate data workflows:
      // 1) Pull office buildings from OpenStreetMap via Overpass (building=office, office=*).
      // 2) Intersect with county assessor parcels (land use codes for office).
      // 3) Sum gross floor area per grid cell and replace metroInventory.
    </script>
  </body>
</html>
